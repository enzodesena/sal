function test_aachen_kemar
%% Load files
filename = 'Kemar_HRTF_sofa.sofa';
s = sofaread(filename)

%% Plot geometry
tol = 1e-6; % Define a small tolerance
idx_ahead = findMeasurementIndex(s, [0, 0, 1] , tol); % straight ahead
hrirs_ahead_matlab = extractResponse(s, idx_ahead);

hrirs_ahead_cpp = [-0.0161564 0.00728521 0.00789486 -0.0169528 0.0329861 -0.0459376 0.0575027 -0.0737824 0.0705525 -0.085494 0.0840864 -0.0669855 0.0638903 -0.0340192 0.00466849 1.21078 1.05539 0.329507 -0.281485 0.269283 -0.07644 -0.850928 -1.15767 -0.752829 -0.0585556 0.0697437 1.2216 0.736074 0.281671 -0.198907 -0.454816 -0.104388 -0.0552448 0.288626 0.00399077 0.0768878 -0.166799 -0.165279 -0.040876 0.0368623 0.0767706 0.00613182 -0.0368173 -0.196837 -0.0292468 -0.0997467 0.00816291 0.03605 -0.00137447 0.0158016 -0.0163796 0.0436917 0.0563967 0.0677846 0.0236645 -0.0480008 -0.028854 -0.0244365 0.0173831 0.0368983 0.000928186 0.0129495 -0.041373 -0.00209174 -0.00958026 0.0288815 0.00250278 0.00966293 -0.0116836 -0.035878 -0.00892755 -0.0214249 0.0221596 -0.00631755 0.0391266 -0.000851812 0.0233378 -0.00480287 -0.00565099 -0.0091449 -0.0144173 0.00031379 -0.0149696 0.00995279 -0.00624753 0.0202164 -0.017836 0.0144123 -0.010403 0.0236716 0.0086267 0.0145325 0.00437898 -0.0150452 0.00851088 -0.0153648 0.0157115 -0.0141706 0.0237845 -0.0219105 0.00302246 -0.013483 0.000186648 -0.00619661 -0.00938047 0.015397 -0.0134648 0.0203822 -0.011943 0.0162451 -0.0154594 0.0167566 -0.00895494 -0.00381715 -0.00753709 -0.0079168 0.00372227 -0.0167031 0.0182107 -0.0164837 0.0134493 -0.0128042 0.0133268 -0.00200952 0.00618444 0.00179168 -0.00645677 -0.0019813 -0.016825 0.0127217 -0.0137433 0.0154897 -0.00543363 0.0103618 -0.00176804 0.00478756 0.00203898 -0.00795872 0.00387724 -0.00939662 0.00728042 -0.00920699 0.00996322 -0.00634651 0.00265274 -0.00213656 -0.000179834 0.00607945 -0.00130308 0.00719679 -0.00775194 -0.0010247 -0.00483879 0.00160359 -0.00346448 0.00352664 0.00326665 -0.00379727 0.000265847 -0.00366548 0.00186731 -0.00333424 0.00439311 0.00297107 0.000134289 0.00361001 -0.00124788 0.00207627 -0.00410174 0.00298372 -0.00178365 0.000384064 -4.32278e-05 -0.000803796 0.0010414 -0.00432764 0.00535136 -0.00487944 0.00379291 -0.00431365 0.00223243 -0.00411952 -0.000340795 0.00249977 -0.00377736 0.00469781 -0.00467611 0.00692348 -0.00719884 0.00662372 -0.00487761 0.0027039 -0.00167924 0.000533008 0.00338245 -0.00490197 0.00781352 -0.00751983 0.00717089 -0.00835927 0.00740202 -0.00688195 0.00299703 -0.000796342 -0.00188256 0.00278468 -0.00617537 0.00771097 -0.00991912 0.00914315 -0.00853868 0.0073199 -0.00661918 0.00397808 -0.00126874 -0.00262661 0.00438848 -0.00619027 0.00796217 -0.00938891 0.0106161 -0.00915875 0.00766923 -0.00570217 0.00398142 -0.00157647 -0.00148561 0.00486002 -0.00670986 0.00808993 -0.00867251 0.00972996 -0.00947745 0.0081969 -0.00586078 0.00344714 -0.00160479 -0.000856297 0.00344614 -0.00616703 0.00785855 -0.00825441 0.00854566 -0.00834826 0.00805974 -0.00631279 0.00413473 -0.00145007 -0.000209138 0.00232806 -0.00413651 0.00643414 -0.00730797 0.00785817 -0.00715837 0.00696526 -0.00607521 0.00474635 -0.0026247 0.000499553 0.0010935 -0.00244372 0.00394722 -0.00536275 0.00614904 -0.00624569 0.00571635 -0.0052492 0.00473783 -0.00371712 0.00228628 -0.000531325 -0.000575509 0.00163772 -0.00247059 0.00377927 -0.00430051 0.00473672 -0.00419993 0.00438908 -0.00395359 0.00376588 -0.00276219 0.00187125 -0.000846309 0.000469609 0.000599605 -0.00154749 0.00266087 -0.00327177 0.00383776 -0.0038786 0.00465687 -0.00457769 0.00469918 -0.00379257 0.00328931 -0.00239019 0.00189114 -1.91744e-05 -0.00110203 0.00288665 -0.00344652 0.00501576 -0.00551862 0.00683813 -0.00650399 0.00664889 -0.00551918 0.00503553 -0.00335145 0.00208037 0.000581859 -0.00223968 0.00450069 -0.00576928 0.00785027 -0.00870754 0.00957817 -0.00902128 0.00859033 -0.00686595 0.00566987 -0.00265548 0.000479145 0.00285582 -0.00511572 0.00791526 -0.00952749 0.0116512 -0.0118718 0.0121951 -0.0106126 0.00963647 -0.00672015 0.00450796 -0.000517803 -0.00267843 0.00672655 -0.00888312 0.0122071 -0.0135656 0.0154018 -0.0145129 0.0141372 -0.0116457 0.00958855 -0.00522492 0.00186322 0.0030924 -0.00642352 0.0115743 -0.013916 0.0165756 -0.0176737 0.0191328 -0.0176987 0.0157797 -0.0114144 0.00897294 -0.00318538 -0.00162081 0.00776409 -0.0121046 0.0163851 -0.0205454 0.0225485 -0.0242937 0.0235443 -0.0214525 0.0182843 -0.012308 0.00862168 -0.000687269 -0.00742909 0.0141338 -0.0204754 0.0262334 -0.0314922 0.036289 -0.0355173 0.0343734 -0.0289277 0.0264518 
-0.0186754 0.0203162 -0.0127154 0.0120764 -0.00233104 -0.00563928 0.0140357 -0.028124 0.0291053 -0.0519293 0.0570093 -0.0577072 0.0695138 -0.0578973 0.0641158 1.18599 1.07083 0.153713 0.255836 0.442038 -0.352974 -1.51172 -1.40578 -0.175408 -0.122749 0.489126 1.14056 0.425285 0.145603 -0.128521 -0.20129 0.02211 0.257307 -0.0310907 -0.24061 -0.137234 -0.183721 0.0521099 0.0113683 -0.143309 0.00428774 0.124482 0.00878924 -0.0264829 -0.0882955 -0.00320119 0.0698272 -0.0683088 -0.132383 -0.0751098 0.0416802 0.0470356 0.0777244 0.02045 0.0251407 0.0394616 0.0151515 0.0132178 -0.0119592 -0.0122233 -0.00355142 -0.0265273 -0.0444331 0.0110149 0.0221486 0.0203426 -0.00728324 -0.00376259 0.00110857 -0.00405845 -0.0101838 -0.0118259 -0.0144061 0.0082089 0.0306408 0.0126075 0.000912437 -0.0134754 -0.00246956 -0.0138983 -0.00604328 -0.00552347 0.000440707 0.00230114 0.0161496 -0.00294345 -0.00117015 0.0120751 0.00116412 0.00829769 -0.00178009 0.0154106 -0.00596335 0.00594629 0.00113447 0.00176871 -0.00898926 0.00395571 0.00706074 -0.0106723 -0.00195866 -0.00820296 -0.00243554 -0.0214627 0.00805615 -0.00530381 0.00271403 -0.00050621 0.00640494 0.00126902 0.000948611 0.0146308 -0.0113367 -0.00837304 -0.0164604 0.00899876 -0.0120306 0.00551189 1.66865e-05 -0.00276001 -0.00163024 0.00201465 0.00603766 -0.00754312 0.00933897 -0.00429237 0.00484905 -0.0129709 0.00854408 -0.00452134 -0.00226991 0.00258296 0.00358244 0.00675578 -0.000160429 0.012319 -0.00980188 0.00345835 -0.00400017 0.00484411 -0.00951505 0.00273473 0.00329106 -0.00240459 0.000921275 -0.00195957 0.00754326 -0.00781069 0.00712808 -0.00583494 -0.00142342 -0.0040697 0.00476359 -0.00369504 -0.00309032 0.00646874 -0.0029013 -0.00125126 -0.00635319 0.00433097 -0.00766708 0.00284906 0.00217239 0.0024326 -0.00104839 0.00298381 0.00255871 -0.00468526 0.00289447 -0.00165543 0.000780002 -0.004351 0.00387933 -0.00142309 -0.00129954 0.000789299 0.00107536 -0.00163597 -0.00202277 0.00274885 -0.00325238 -0.000825262 0.000682101 0.00140695 -0.00263827 0.00110779 0.00167275 -0.00114197 -0.000440258 0.00137528 -3.79797e-05 -0.00148293 0.00162906 0.00182858 -0.00125139 0.000819959 0.0017373 -0.000845827 -0.00126562 0.00109768 0.000367546 -0.00286346 0.00134444 -0.00050218 -0.000504393 -0.00217296 0.00198969 -0.00160231 -0.00102693 0.000994276 -0.000199071 -0.000407304 -0.00167658 0.00288502 -0.00338452 0.00117984 -0.00105256 0.00181812 -0.00234335 0.00152112 0.00119715 -0.00164714 0.00149597 -0.000985623 0.00226985 -0.00377592 0.00401673 -0.0024268 0.00138867 -0.0013788 0.0019701 -0.000666738 -0.00138911 0.00272065 -0.00271337 0.00215171 -0.00306761 0.00406764 -0.00431085 0.00284866 -0.00128077 0.000909256 -0.000820607 8.02082e-05 0.00209846 -0.00345236 0.00380347 -0.0029918 0.00351756 -0.00395078 0.00428575 -0.00264325 0.00125056 5.85954e-05 6.53382e-05 0.00103336 -0.00239266 0.00408004 -0.00421257 0.00367973 -0.00339431 0.00389109 -0.00365883 0.00258889 -0.000629186 -0.000408747 0.000975546 -0.00139734 0.0029121 -0.00399045 0.00458632 -0.00360446 0.00342171 -0.00315814 0.00340105 -0.00191812 0.000768435 0.000965431 -0.000971408 0.0019528 -0.00247003 0.00404189 -0.0040565 0.00390891 -0.00288065 0.00318144 -0.00267341 0.00213613 -0.000523274 -0.000340888 0.00142328 -0.001249 0.00252008 -0.00311191 0.00413466 -0.00338365 0.00323089 -0.00257344 0.00317857 -0.00204426 0.00146481 0.000373468 -0.000297494 0.00139447 -0.00147958 0.00310329 -0.00309193 0.003934 -0.00283618 0.00342673 -0.00294733 0.00331512 -0.00168515 0.00127443 0.000205231 2.29492e-05 0.00137411 -0.00191067 0.00354374 -0.0034908 0.00415774 -0.00342731 0.00455311 -0.00359221 0.00364139 -0.00173924 0.00151478 1.70104e-05 -0.000112581 0.00229112 -0.00284067 0.00457651 -0.00413235 0.005397 -0.00467224 0.00585691 -0.00427582 0.0041598 -0.00180318 0.00182666 0.000416442 -0.00123971 0.0039664 -0.00428761 0.00622438 -0.00586353 0.00743341 -0.00652579 0.00702102 -0.00502937 0.00450278 -0.00157265 0.000990138 0.00215642 -0.00320502 0.0066038 -0.00697767 0.00837431 -0.00840673 0.0100185 -0.00869694 0.00800712 -0.00495384 0.00403227 -0.00117716 -0.00139822 0.00490062 -0.00730642 0.00965063 -0.0108015 0.0123836 -0.0127689 0.013073 -0.0107084 0.00888201 -0.00539639 0.00270633 0.00168098 -0.00574768 0.010975 -0.0137497 0.0178158 -0.0182489 0.0223431];
hrirs_ahead_cpp = hrirs_ahead_cpp';
figure(1)
plotResponse(hrirs_ahead_matlab, s.SamplingRate);
hold on;
plotResponse(hrirs_ahead_cpp, s.SamplingRate);
hold off;
plotbrowser
getMax(hrirs_ahead_matlab)./getMax(hrirs_ahead_cpp)

% Left
idx_left = findMeasurementIndex(s, [90, 0, 1] , tol); % left side (I think)
hrirs_left_matlab = extractResponse(s, idx_left);
hrirs_left_cpp = [-0.195656 0.29265 -0.415612 1.01122 2.90686 0.838251 0.957453 -1.99708 -2.6968 -1.46909 -0.992871 1.55236 2.31515 2.1399 -0.349113 -1.31487 -1.24921 -1.00203 0.495907 0.757834 0.413593 0.063976 -0.303488 -0.575967 -0.34222 -0.0879556 0.237703 0.230863 0.15329 0.134813 0.0391709 -0.134292 -0.16955 -0.130396 -0.129956 -0.0816709 0.0284331 0.184007 -0.0135786 -0.00977156 -0.0939089 -0.0140612 0.0505782 0.0517895 0.0727275 -0.0198333 -0.0388648 -0.0751973 -0.036579 -0.0459581 0.0220165 -0.00293495 0.0260069 -0.00946284 0.015109 0.00266789 -0.0175011 -0.00533095 -0.040654 0.0118504 0.0202426 0.0488323 0.0200927 -0.00748232 -0.0379564 -0.0257554 -0.0399132 0.020621 0.00692804 0.0277916 0.0102591 -0.0161476 -0.00835358 -0.0285228 0.0283991 0.00956965 0.0426101 0.00803606 0.027592 -0.0132334 0.000901679 -0.0167674 -0.00970662 -0.00337322 -0.00954074 0.0191896 -0.0138761 0.0195868 -0.0323597 0.00456278 -0.036206 0.00106225 -0.020778 -0.00850342 -0.0112809 -0.0184961 0.00666996 -0.0316546 0.0267086 -0.0228178 0.010682 -0.0191201 0.00709882 -0.0164346 0.00887209 -0.0032277 -0.0104715 0.00534683 -0.0285405 0.0174998 -0.0260029 0.0260522 -0.0111692 0.0155337 -0.0113947 -0.00256314 -0.0135536 -0.0139035 0.0164304 -0.00561385 0.0254346 -0.0181763 0.0191419 -0.0209069 0.00742663 -0.00594097 0.00767975 0.00597193 -0.00489819 0.00472598 -0.0162263 0.0122769 -0.00861105 0.0179075 -0.0134987 0.0110965 -0.008792 0.00337284 0.00120658 -0.000397572 0.0118527 -0.0109489 0.0095202 -0.0123336 0.0083174 -0.00465656 0.00717247 -0.00884001 0.00303683 0.00231888 -0.00159897 0.00533687 -0.00585957 0.00758831 -0.0118542 0.00317365 -0.00582837 0.00266339 -0.00115698 0.000169465 0.000177594 -0.00390917 0.00291721 -0.00386926 0.00211472 -0.00390293 0.00342155 -0.00325872 -0.00197423 0.000301426 -0.00405064 0.000424452 -0.00224596 0.0023959 -0.00277128 -0.00127088 -0.000531134 -0.00290373 0.000185341 -0.00345776 0.00309346 -0.00524141 0.00208933 -0.00272388 -0.00102108 -0.000799255 -0.00216018 0.00281782 -0.00624549 0.00511524 -0.00610063 0.00386984 -0.00554326 0.00306846 -0.00282517 -0.00110321 0.00240135 -0.0039705 0.00503352 -0.00727512 0.00767708 -0.00889795 0.00641688 -0.00553725 0.00406156 -0.0017533 0.000119994 0.00392 -0.0057739 0.00779823 -0.00787024 0.00962865 -0.0091696 0.00941787 -0.00626109 0.00457405 -0.00135319 -0.000217081 0.0037462 -0.00601838 0.00916385 -0.00962817 0.0104245 -0.0097477 0.00974043 -0.00780447 0.00541646 -0.00187382 -0.000601103 0.00349991 -0.0057285 0.00865429 -0.0102279 0.0112682 -0.0103041 0.00972422 -0.00805865 0.00641555 -0.00319551 0.000114982 0.00316457 -0.00511211 0.00765269 -0.00917889 0.0107402 -0.0106775 0.00989424 -0.00812326 0.00673696 -0.00422797 0.00185661 0.00159036 -0.00399606 0.00611271 -0.00745516 0.0091047 -0.00942761 0.00994066 -0.00822916 0.00711474 -0.00507522 0.00347834 -0.000747741 -0.00110348 0.00443556 -0.00500048 0.00703928 -0.00723805 0.00862752 -0.00759471 0.0080387 -0.00530459 0.00534309 -0.00274875 0.00217523 0.000892549 -0.00157023 0.00461879 -0.00388199 0.00676266 -0.00599276 0.0079346 -0.00620664 0.00698883 -0.00462904 0.00548702 -0.00241301 0.0029064 0.000906671 -0.000560393 0.00356293 -0.00334658 0.00659749 -0.0056888 0.00853061 -0.00640892 0.0084787 -0.00619577 0.00716426 -0.00387612 0.00417613 0.000150949 0.00022078 0.00388421 -0.00437138 0.0080754 -0.00787177 0.0107705 -0.00916301 0.0115843 -0.00875047 0.00934196 -0.00542281 0.00455257 -5.77621e-06 -0.00119018 0.0063807 -0.00753547 0.0121154 -0.0119482 0.0149491 -0.0134644 0.014909 -0.0111261 0.0106036 -0.00518529 0.00337407 0.00268002 -0.00510897 0.0111553 -0.0127108 0.0177066 -0.0171513 0.0199441 -0.0173658 0.0174087 -0.0124769 0.0099519 -0.00338649 0.000407693 0.0076476 -0.0108223 0.0176218 -0.0200352 0.0239142 -0.024029 0.0251205 -0.0207994 0.0198088 -0.0132281 0.00825279 -0.000607467 -0.00561744 0.013627 -0.0194846 0.026601 -0.0299595 0.032453 -0.0339217 0.0327974 -0.0281019 0.0233673 -0.0145358 0.00658964 0.00384627 -0.0148837 0.024594 -0.0341204 0.0442135 -0.047852 0.0541341 -0.0527637 0.054524 -0.0453668 0.0393517 -0.0215979 0.0107863 0.00926655 -0.0361187 0.0502476 -0.0932605 0.101212 -0.143485 0.194706 
-0.00131408 -0.000681562 -0.00102334 -0.000710499 -0.00123954 -0.000977839 -0.000648694 -0.00121396 -0.000665045 -0.00128628 -0.000229058 -0.00152149 2.09832e-05 -0.00175902 -0.000215696 -0.00095114 -0.00140854 0.000388763 -0.000835183 0.00213518 0.000868949 0.00192353 0.000688551 0.000945031 0.0002462 -0.000351071 -0.00261919 -0.00210479 -0.00388132 -0.00185128 -0.00063522 1.25804e-05 0.0715237 0.155207 0.186691 0.222108 0.248358 0.198762 0.130236 0.105025 0.0830031 -0.0290161 -0.14589 -0.0749133 -0.0230176 -0.114514 -0.138386 -0.0453366 0.0636693 0.136727 0.137761 0.0526286 -0.0284049 -0.0627201 -0.062365 -0.0433608 -0.0250693 0.00372504 0.0137996 -0.00909499 -0.00721692 0.0211601 0.0354429 0.0249287 0.00166529 -0.0106858 -0.0107481 -0.004729 -0.00571671 -0.0177695 -0.0221457 -0.0119097 -0.00233566 0.00264181 0.00163356 0.00423227 0.00335537 -0.00339973 -0.0033855 -0.00558145 -0.00193213 6.88102e-05 -0.00123583 -0.00183879 0.0024918 0.00695569 0.00853876 0.00525232 0.000663636 -0.000924295 -0.00485415 0.00139184 0.0034579 0.00611581 0.00782802 0.00767978 0.00954346 0.0100739 0.0100183 0.00564896 -0.000473013 -0.00496592 -0.00247394 -0.00366648 -0.000927403 -0.0023444 -0.000974167 0.0034342 0.00179057 0.00107079 -0.00214683 0.000189446 0.00386622 0.00819315 0.0087772 0.00797257 0.00462388 0.00367492 0.00635849 0.00776458 0.00496306 0.00143527 0.00540059 0.00508349 0.00544272 0.00640469 0.00420529 0.00194808 0.0041435 0.00472564 0.00501939 0.00498469 0.0030578 0.00326855 0.00137314 0.00272025 -0.000268256 -0.0040047 -0.00528975 -0.00405415 -0.00142446 -0.00126721 -0.000781732 -0.00139895 -0.00105291 0.000946568 0.00355678 0.00194586 -0.000576585 -0.00224276 -0.00314541 -0.00246618 -0.00113898 -0.00132598 -0.00329824 -0.00368805 -0.00227895 -0.000706976 -0.00072087 0.000428517 -0.000489075 -0.00195931 -0.00128456 -0.000865035 -0.000696761 -0.000564665 0.000860644 0.000806359 0.000107865 0.000945208 0.00150858 0.00169137 0.00202186 0.00193721 0.000491991 4.02649e-05 0.000851934 0.000830531 0.000238479 0.000274457 0.000637691 -0.000266388 -1.62819e-05 0.00045275 0.000366975 0.000239015 0.000685403 0.000953753 0.000342259 0.000874159 0.00102225 0.000838066 0.000613131 0.0016416 0.00162829 0.00139283 0.0017511 0.00167948 0.0013895 0.00121343 0.00192275 0.0011881 0.00120005 0.00125635 0.0014029 0.000798661 0.000916919 0.00107727 0.000282695 0.00029443 0.000183532 0.000228095 -0.000517199 5.84581e-05 -0.000269475 -0.000432231 -0.000435542 -0.000221752 -0.000452487 -0.000836638 -0.00025874 -0.000721987 -0.000617713 -0.000777294 -0.000207218 -0.000749151 -0.000475618 -0.000261247 -0.000418923 -0.000453602 -0.000395268 -3.47629e-05 -0.000720648 -0.000181164 -0.000457038 -0.000371084 -0.000747087 -0.000320699 -0.000518486 -0.000811261 -0.000417402 -0.000582124 -0.000457616 -0.000774582 -0.000119066 -0.000675967 -0.000436885 -0.000444496 -0.000238727 -0.00040154 -0.000295768 0.000143738 -0.000289882 0.000100504 -3.48866e-05 0.000271342 -0.000223024 0.000241103 0.000115302 8.84552e-06 4.36566e-05 5.51079e-05 0.000145899 -0.000249406 0.000176972 -0.000173097 -4.94657e-05 -0.0002596 3.46071e-05 -0.000316111 -0.000250611 -7.46484e-05 -0.000314272 -0.000172861 -0.000351108 -4.96119e-05 -0.000409627 -0.000161408 -0.000184513 -0.000251444 -0.00031331 -0.000209109 -0.000176256 -0.000379099 -0.000279074 -0.000257923 -0.000365419 -0.000456063 -0.000290176 -0.00047201 -0.000503575 -0.000518684 -0.000448939 -0.000688874 -0.000580909 -0.000572464 -0.000602046 -0.000690727 -0.000703381 -0.000619844 -0.000823107 -0.000628378 -0.000697961 -0.00065327 -0.000762837 -0.000655958 -0.000771261 -0.000766637 -0.000653714 -0.000691486 -0.000745122 -0.000745159 -0.000635136 -0.000716137 -0.000705926 -0.000722528 -0.000638395 -0.000816669 -0.000714642 -0.000739922 -0.000733421 -0.000722032 -0.000706722 -0.000785698 -0.000833926 -0.000696654 -0.000711553 -0.000781735 -0.00078271 -0.000668552 -0.000770074 -0.000736148 -0.000717758 -0.00067524 -0.000808945 -0.000653508 -0.000739205 -0.000650741 -0.000706025 -0.000643375 -0.00065572 -0.000764611 -0.000623929 -0.000767425 -0.000674785 -0.00082475 -0.000546682 -0.000849226 -0.000647954 -0.00077707 -0.000749682 -0.000805829 -0.00084449 -0.000657456 -0.000928346 -0.000720471 -0.000807819 -0.000645082 -0.000943325 -0.00052902 -0.000813922 -0.000679772 -0.000829538 -0.000704797 -0.000708289 -0.000845981 -0.000598437 -0.000935387 -0.00055491 -0.000908177 -0.000600034 -0.000955277 -0.000630219 -0.000846726 -0.000714551 -0.000857652 -0.000678824 -0.000736936 -0.000907163 -0.000601369 -0.00108268 -0.000670327 -0.00122539 -0.000717841];
hrirs_left_cpp = hrirs_left_cpp';
figure(2)
plotResponse(hrirs_left_matlab, s.SamplingRate);
hold on;
plotResponse(hrirs_left_cpp, s.SamplingRate);
hold off;
plotbrowser
getMax(hrirs_left_matlab)./getMax(hrirs_left_cpp)

% Up
idx_up = findMeasurementIndex(s, [0, 90, 1] , tol); % left side (I think)
hrirs_up_matlab = extractResponse(s, idx_up);
hrirs_up_cpp = [0.00702746 -0.0141107 0.00786127 -0.0201691 0.00559943 -0.020267 0.00572712 -0.0112042 0.00468239 0.00724965 -0.00145303 0.422281 0.587546 0.709445 0.969307 0.388146 -0.995956 -1.48137 -0.916834 -0.134102 0.681159 0.852512 0.524352 0.0297555 -0.291564 -0.445012 -0.267947 0.131313 0.330363 0.228948 -0.0975537 -0.203666 -0.15543 0.011775 0.028549 -0.00810585 0.0079991 0.0585737 0.128152 0.0916702 0.030974 -0.0391366 -0.0154296 -0.0578115 -0.0664331 -0.0380182 0.0260692 0.0614313 0.0133308 -0.0228732 -0.054131 -0.00444739 0.0460662 0.063747 0.0321844 0.0167368 0.0229542 0.0284435 -0.00461177 -0.0483301 -0.056766 -0.0400371 -0.0236936 -0.0217042 -0.0146242 -0.0208396 -0.0167176 -0.0219044 -0.0174157 0.0044807 0.0609872 0.0666795 0.0159883 -0.0403661 -0.0635424 -0.0351254 -0.00214899 0.0218019 0.0126359 0.0113603 -0.00385993 -0.0124868 -0.0164767 -0.00638706 0.00954427 0.0169978 0.0106059 -0.00677257 -0.00688417 -0.00950528 -0.00384176 -0.0129705 -0.00879966 0.00191316 0.01123 0.0116255 0.000735681 -0.00719617 -0.0101824 -0.00595718 0.000449261 0.00602698 0.00390918 0.00773031 0.00324752 -0.0032639 -0.00279738 0.0006038 -0.000794249 0.00300869 0.000913253 0.000841982 -0.001319 -0.00148532 -0.00275327 -0.00829878 -0.00352123 -0.00270555 0.0036712 0.00333427 0.00354955 -0.00430003 -0.00331075 -0.0072362 -0.00114409 -0.000929003 -0.00305854 0.00162803 -0.00547245 0.00169276 -0.00607603 -0.000103194 -0.00794661 -0.00198402 -0.000705757 -0.00117614 0.00260409 -0.000199162 0.00547318 -0.00377177 0.00372293 -0.000296262 0.00752664 0.00279672 0.00374333 -0.00349941 -0.00550748 -0.00125903 -0.00526401 0.00204368 -0.00494573 0.00492126 -0.00532705 0.000830864 -0.00134751 -0.000109948 0.00158793 6.95557e-05 0.00424091 -0.00236931 0.00233508 -0.00459509 0.00161434 -0.00392314 0.00314995 -0.000838463 -0.000147849 0.00080144 -0.002706 0.00120814 -0.00507405 0.00229949 -0.00355961 0.00236895 -0.00132109 0.00227252 -0.000359765 -0.00100082 -0.000435915 -0.00404955 0.00128276 -0.00266994 0.00345818 -0.00261107 0.0023576 -0.00121533 0.000491534 0.000344847 -0.000162044 0.00204711 -0.00190226 0.00294602 -0.00225692 0.00195823 -0.00198592 0.00142236 -0.00107707 -0.000318851 0.000925038 -0.00126533 0.00162688 -0.00214362 0.00194357 -0.00264859 0.00120016 -0.00132145 0.000275924 -0.000162512 -0.000729393 0.0010324 -0.00243386 0.00131296 -0.00238845 0.00115155 -0.0019354 0.000833437 -0.000730705 -0.000823236 0.000399943 -0.00184345 0.000940316 -0.00251768 0.00153187 -0.00245262 0.000578138 -0.001489 -0.000499554 -0.000653309 -0.0017638 0.000764762 -0.00275036 0.00114144 -0.00276153 0.000947403 -0.00255456 0.000168878 -0.00118092 -0.0012612 0.000245204 -0.00203744 0.0013267 -0.00283966 0.00190486 -0.00257397 0.00127326 -0.00150988 0.000478656 -0.000139956 -0.000817667 0.00158313 -0.00188768 0.00230459 -0.00225118 0.00266768 -0.00197926 0.00202898 -0.000616406 0.000859567 0.00082346 -0.000367584 0.00236023 -0.00149102 0.003439 -0.00150005 0.0035845 -0.000903538 0.00310515 0.000314554 0.00171386 0.00204405 0.000558551 0.00348314 -0.000316416 0.00465016 -0.000506394 0.00458209 -1.34325e-05 0.00380292 0.0012761 0.00280296 0.00296784 0.00129598 0.00406708 0.000545431 0.00487681 0.000227606 0.00507782 0.000772379 0.00432617 0.00183427 0.00326632 0.00293983 0.00205997 0.0041773 0.00136935 0.00486717 0.00102965 0.00499639 0.00120438 0.00445269 0.0019188 0.00364055 0.0028123 0.00287058 0.00364772 0.00186802 0.00422029 0.00151333 0.00439437 0.00145802 0.00419795 0.00167415 0.00351321 0.00205524 0.00289255 0.00253527 0.00244419 0.0031804 0.0018825 0.00310451 0.00158862 0.00328587 0.00125019 0.00321419 0.00115529 0.00297025 0.00114798 0.00271688 0.00125733 0.00215837 0.0016863 0.00161351 0.00196282 0.000788137 0.00235915 -5.39345e-05 0.00275693 -0.000292534 0.0028551 -0.000728954 0.00236428 -0.000460475 0.0014733 0.000177453 0.000460891 0.000934806 -0.000901225 0.00222079 -0.00205908 0.00258761 -0.00301217 0.00246031 -0.00341754 0.00144042 -0.00185181 0.000767014 -0.000729112 -0.00146394 0.000987913 -0.00439891 0.00183577 -0.00526939 0.00233855 -0.00640573 0.00211162 -0.00566706 9.81213e-05 -0.00336425 -0.00122413 -0.000464946 -0.00458559 0.00170932 -0.00846049 0.00218757 -0.00970148 0.00468132 -0.00793748 0.00384301 -0.00647877 -0.000782699 -0.00362167 -0.00396688 0.00302272 -0.00829539 
0.00888452 -0.0112785 0.00311395 -0.00996236 -0.00609628 -0.00406284 -0.0156599 0.00996223 -0.0227384 0.0354076 -0.0428043 0.208302 0.434995 0.594743 0.957913 0.828754 -0.413283 -1.49807 -0.926573 -0.217645 0.310384 0.492586 0.259359 0.125409 -0.018804 0.00367376 0.0120907 0.0510144 0.0303364 -0.0327036 -0.175433 -0.111962 0.0416087 0.0521809 -0.0162535 -0.102158 -0.00958637 0.0998817 0.174151 0.0918771 -0.00913555 -0.0710708 -0.0289134 0.0201342 -0.00721924 -0.021741 -0.0339821 -0.0143641 -0.00788422 0.00575368 0.0158187 0.0559983 0.0297339 0.0021887 -0.00312307 0.0161107 0.0566395 0.0579792 -0.00348787 -0.0817993 -0.0922111 -0.0953996 -0.0670936 -0.024505 0.00824524 0.00553806 0.0248628 0.0328798 0.0241738 0.0462021 0.0626449 0.0178827 -0.0584722 -0.0763244 -0.056664 -0.0131285 0.0118969 0.022395 0.0109741 0.0127057 0.00997802 0.00948308 0.00505062 -0.00652588 -0.00744406 -0.0167384 -0.0033856 0.00327127 0.00409341 -0.00707944 -0.0110508 -0.0155162 -0.00242189 0.0100476 0.0126775 0.0027433 -0.0100133 -0.00491797 -0.0045082 9.37693e-05 -0.000962929 -0.000332114 -0.00589517 0.00407976 0.00362589 0.00752099 0.00618618 0.00534029 -0.000832709 -0.00785533 0.00149236 -0.00105769 0.00222258 -0.00452833 -0.000263204 -0.00650909 -0.000795928 -0.000324558 0.00033894 -0.00229343 -0.00264794 0.00312036 -0.00407161 0.00253222 -0.00104775 0.00349956 -0.00491713 -0.000938993 -0.00170112 0.000239559 0.00020339 -0.00293772 -0.00418963 -0.00804037 0.00200712 -0.00306759 0.000736041 -0.00187539 0.00424783 0.00091714 0.00248379 0.00471369 0.00360885 0.00296175 -0.00032821 0.00100046 -0.00589144 -0.000527151 -0.00369337 -0.000922899 -0.00327046 0.00196534 -0.000245402 -0.00305277 0.000403456 -0.000299357 0.00136239 -0.00174309 0.00205229 -0.00264486 2.14371e-05 -0.00145934 0.000430676 -0.00201088 -0.00113241 0.000784249 -0.00168176 -0.000310372 -0.00194826 -8.12951e-05 -0.00246423 0.00115119 -0.000383112 -0.000257325 -0.000671929 0.00157779 0.000864067 -0.000917444 -0.000165091 -0.00178856 -0.000643008 -0.000321398 0.00181875 -0.000399965 0.000278094 0.000320151 0.000777288 0.000120326 0.00111352 0.000776437 -0.000416352 1.59018e-05 0.000458699 9.20317e-05 -0.000700933 0.000378037 -0.000488918 -0.000445075 -0.000430161 0.000826803 -0.000817828 6.6145e-05 -0.000150774 0.000193511 -0.000756034 0.000277481 0.000259735 -0.000718674 0.000119705 -0.000546066 2.31271e-06 -0.00169228 0.000674444 -0.00117428 1.0296e-05 -0.000899577 0.000298835 -0.00101644 -0.000951669 1.28978e-06 -0.00154601 -0.000261821 -0.00169343 0.000551153 -0.00235988 0.000311107 -0.00149203 -0.00037745 -0.00157645 -0.000583492 -0.000512604 -0.00188943 0.000202628 -0.00193762 0.000311788 -0.00239225 0.000941352 -0.00210427 1.95065e-05 -0.00113336 -0.000245654 -0.000702342 -0.00110875 0.000760576 -0.001852 0.00107189 -0.00168546 0.00152105 -0.00187507 0.00138277 -0.000687626 0.0004308 3.75968e-05 1.13287e-05 0.0010211 -0.00108062 0.00210377 -0.00115254 0.00216419 -0.00103375 0.00252716 -0.000468072 0.00166118 0.000893545 0.00102142 0.00172784 0.000462118 0.00293483 -0.000273003 0.00330175 9.00733e-05 0.0033411 0.000359025 0.00326129 0.0012926 0.00228297 0.00227752 0.00176346 0.0031697 0.000948893 0.00425044 0.00067355 0.00406511 0.000853982 0.00407927 0.00135109 0.0035422 0.00245122 0.00256914 0.00319674 0.00196945 0.00405533 0.00115049 0.00453622 0.00121595 0.00457555 0.00135449 0.00439104 0.00181846 0.00338697 0.00283596 0.00264457 0.00349602 0.00181919 0.00444154 0.00104432 0.00453949 0.000949667 0.00456002 0.00111668 0.00417979 0.00182076 0.002956 0.00251307 0.00206575 0.00341232 0.00112373 0.00426673 0.000498361 0.00433008 0.000235568 0.00433345 0.000372123 0.00349232 0.00113696 0.00235346 0.00195483 0.00119271 0.00306134 -6.39388e-05 0.00377961 -0.000778751 0.00416727 -0.00114901 0.00393155 -0.000848357 0.00268978 0.000211341 0.00143796 0.00144291 -0.000470417 0.00281533 -0.0018319 0.00351785 -0.0027465 0.00365002 -0.003019 0.00303773 -0.00216746 0.00166437 -0.000755731 -0.000214915 0.000635984 -0.00271296 0.00252972 -0.00424631 0.00321639 -0.00531481 0.00372501 -0.00512085 0.00193153 -0.00396283 6.48615e-05 -0.00210291 -0.00277403 0.000441937 -0.00582762 0.00252837 -0.00741504 0.00397124 -0.00845021 0.00401106 -0.00756741 0.00167428 -0.00559868 -0.00139605 -0.00210199 -0.00515148 0.00244038 -0.00886231 0.0058165 -0.0115501 0.00893449 -0.011635];
hrirs_up_cpp = hrirs_up_cpp';
figure(3)
plotResponse(hrirs_up_matlab, s.SamplingRate);
hold on;
plotResponse(hrirs_up_cpp, s.SamplingRate);
hold off;
plotbrowser
getMax(hrirs_up_matlab)./getMax(hrirs_up_cpp)


function hrirs = extractResponse(s, idx)
left_ear_hrir = squeeze(s.Numerator(idx, 1, :));
right_ear_hrir = squeeze(s.Numerator(idx, 2, :));
hrirs = [left_ear_hrir(:), right_ear_hrir(:)];

function plotResponse(hrirs, sample_rate)
[ir_length, ~] = size(hrirs);
t = 0:(1/sample_rate):((ir_length-1)/sample_rate);
% plot(t, squeeze(s.Numerator(idx, 1, :)), t, squeeze(s.Numerator(idx, 2, :)))
max_left = max(max(hrirs(:,1)));
max_right = max(max(hrirs(:,2)));
max_max = max(max_left, max_right);
plot(t, hrirs(:,1)./max_max, t, hrirs(:,2)./max_max);

function max_max = getMax(hrirs)
max_left = max(max(hrirs(:,1)));
max_right = max(max(hrirs(:,2)));
max_max = max(max_left, max_right);

function idx = findMeasurementIndex(s, targetPosition, tol)
idx = find(all(abs(s.SourcePosition - targetPosition) < tol, 2));